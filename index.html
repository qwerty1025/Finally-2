<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>五寮尖 - 戰情總部 V8.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' },
                        // 視覺色彩微調：更沈穩的戰情室風格
                        status: {
                            match: '#10b981', // 綠 (吻合)
                            diff: '#ef4444',  // 紅 (差異)
                            warn: '#f59e0b'   // 黃 (警告)
                        }
                    },
                    fontSize: { 'xxs': '0.65rem' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #cbd5e1; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        [v-cloak] { display: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* 泳道樣式優化 */
        .swimlane-container { scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .swimlane-col { scroll-snap-align: start; flex-shrink: 0; width: 90vw; }
        @media (min-width: 768px) { .swimlane-col { width: 360px; } }

        /* 校對儀專用樣式 */
        .diff-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background-color: #334155; border: 1px solid #334155; }
        .diff-cell { background-color: #1e293b; padding: 8px; text-align: center; }
        .diff-header { background-color: #0f172a; font-weight: bold; font-size: 0.75rem; padding: 8px; text-align: center; color: #94a3b8; }
        
        /* 動態輸入框 */
        .smart-input {
            width: 100%;
            height: 120px;
            background-color: #0f172a;
            color: #f8fafc;
            border: 2px solid #334155;
            border-radius: 0.75rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 1rem;
            line-height: 1.5;
            outline: none;
            transition: border-color 0.2s;
        }
        .smart-input:focus { border-color: #3b82f6; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

<div id="app" v-cloak class="h-full flex flex-col relative">

    <header class="bg-slate-900 border-b border-slate-800 p-3 flex justify-between items-center z-20 shadow-md">
        <div class="flex items-center gap-3">
            <h1 class="text-sm font-bold tracking-widest text-slate-100 flex items-center gap-2">
                <i class="fas fa-layer-group text-blue-500"></i> 
                <span>戰情總部</span>
            </h1>
        </div>
        <div class="flex gap-4 text-right">
            <div>
                <div class="text-[10px] text-slate-500 uppercase tracking-wider">今日配送</div>
                <div class="text-lg font-mono font-bold text-white leading-none">
                    {{ currentDayStats.bottles }} <span class="text-xs text-slate-500">瓶</span>
                </div>
            </div>
            <div>
                <div class="text-[10px] text-slate-500 uppercase tracking-wider">生乳需求</div>
                <div class="text-lg font-mono font-bold leading-none" :class="currentDayStats.weight > 40 ? 'text-red-500' : 'text-emerald-400'">
                    {{ currentDayStats.weight.toFixed(1) }} <span class="text-xs text-slate-500">kg</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-x-auto hide-scroll swimlane-container flex gap-0 p-0 bg-slate-950">
        <div v-for="date in activeDates" :key="date.key" 
             class="swimlane-col flex flex-col h-full border-r border-slate-800 bg-slate-900/50 relative">
            
            <div class="bg-slate-900 p-3 border-b border-slate-800 sticky top-0 z-10 flex justify-between items-center">
                <div>
                    <span class="text-xl font-bold text-white mr-2">{{ date.label }}</span>
                    <span class="text-xs text-slate-400 font-mono">{{ date.key.slice(5) }}</span>
                </div>
                <div class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-300 border border-slate-700">
                    {{ date.orders.length }} 單
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-3 pb-24">
                <div v-for="order in date.orders" :key="order.id" 
                     class="bg-slate-800 rounded-lg p-4 shadow border-l-4 relative group"
                     :class="[
                        order.distMismatch ? 'border-red-500 ring-1 ring-red-500/50' : 'border-slate-600',
                        order.isDone ? 'opacity-30 grayscale' : ''
                     ]">
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold px-2 py-0.5 rounded"
                              :class="order.distMismatch ? 'bg-red-500 text-white animate-pulse' : 'bg-slate-700 text-slate-400'">
                             {{ order.district }}
                        </span>
                        <div class="flex gap-1">
                            <span v-for="(qty, sku) in order.items" :key="sku" v-show="qty > 0"
                                  class="w-2 h-2 rounded-full" :style="{backgroundColor: getProductColor(sku)}">
                            </span>
                        </div>
                    </div>

                    <h3 class="font-bold text-slate-200 text-lg">{{ order.name }}</h3>
                    
                    <div class="mt-2 text-xs text-slate-400 flex flex-wrap gap-2">
                        <span v-for="(qty, sku) in order.items" :key="sku" v-show="qty > 0">
                            {{ getProductName(sku) }} x{{ qty }}
                        </span>
                    </div>

                    <div v-if="order.distMismatch" class="absolute -top-2 -right-2 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shadow-lg animate-bounce">
                        !
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="fixed bottom-6 right-6 z-30">
        <button @click="reconciler.open = true" 
                class="w-16 h-16 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-2xl shadow-blue-500/30 flex items-center justify-center text-2xl transition-all active:scale-90 border-2 border-slate-900">
            <i class="fas fa-edit"></i>
        </button>
    </div>

    <div v-if="reconciler.open" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" @click="reconciler.open = false"></div>
        
        <div class="bg-slate-900 w-full sm:max-w-lg h-[85vh] sm:h-auto sm:rounded-2xl rounded-t-2xl shadow-2xl relative flex flex-col border border-slate-700">
            
            <div class="p-4 bg-slate-850 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-calculator text-blue-500"></i> 文字快手校對
                </h2>
                <button @click="reconciler.open = false" class="w-8 h-8 rounded-full bg-slate-700 text-slate-400"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-4 overflow-y-auto flex-1">
                
                <div class="mb-4">
                    <label class="text-xs text-slate-400 block mb-2">貼上 Line / 筆記本內容 (例如: 樹林1 土城4...)</label>
                    <textarea v-model="reconciler.text" 
                              class="smart-input" 
                              placeholder="在此貼上文字..."
                              @input="parseAndCompare"></textarea>
                </div>

                <div v-if="reconciler.diffs.length > 0" class="space-y-4">
                    <div class="flex justify-between items-end">
                        <h3 class="text-sm font-bold text-slate-300">比對結果 (例外管理)</h3>
                        <span class="text-xxs text-slate-500">根據今日泳道計算</span>
                    </div>

                    <div class="rounded-lg overflow-hidden border border-slate-700">
                        <div class="diff-grid border-none">
                            <div class="diff-header">區域</div>
                            <div class="diff-header">輸入 / 系統</div>
                            <div class="diff-header">狀態</div>
                        </div>
                        <div v-for="row in reconciler.diffs" :key="row.district" class="diff-grid text-sm">
                            <div class="diff-cell text-slate-300 font-bold border-t border-slate-800">{{ row.district }}</div>
                            
                            <div class="diff-cell border-t border-slate-800 text-slate-400">
                                <span class="text-white">{{ row.inputQty }}</span> / {{ row.sysQty }}
                            </div>
                            
                            <div class="diff-cell border-t border-slate-800 font-bold flex items-center justify-center gap-1"
                                 :class="getStatusColor(row.diff)">
                                <i :class="getStatusIcon(row.diff)"></i>
                                {{ getStatusText(row.diff) }}
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-3 rounded-lg text-xs text-slate-400 border border-slate-700">
                        <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                        <span v-if="hasErrors">系統內有 <strong>{{ errorCount }}</strong> 個區域數量不符，請檢查對應區域的卡片。</span>
                        <span v-else class="text-emerald-400">完美吻合！所有區域數量正確。</span>
                    </div>

                    <button @click="highlightErrors" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-sm shadow-lg transition-colors">
                        標記差異卡片 (在看板顯示)
                    </button>
                </div>

                <div v-else class="text-center py-8 text-slate-600">
                    <i class="fas fa-keyboard text-3xl mb-2 opacity-50"></i>
                    <p class="text-xs">等待輸入文字...</p>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    const PRODUCT_CONFIG = {
        'sku_big': { name: '大', color: '#1e3a8a', weight: 0.95 },
        'sku_med': { name: '中', color: '#059669', weight: 0.50 },
        'sku_sml': { name: '小', color: '#ea580c', weight: 0.18 }
    };

    createApp({
        setup() {
            const activeDates = ref([]);
            
            // 校對儀狀態
            const reconciler = ref({
                open: false,
                text: '', // 使用者輸入的原始文字
                diffs: [] // 計算後的差異
            });

            // 初始化假資料
            const initData = () => {
                const today = new Date().toISOString().split('T')[0];
                // 模擬今日的系統資料 (對應您的例子：第一次輸入)
                const mockOrders = [
                    { id: '1', dist: '樹林', name: '王先生', items: { sku_big: 1 } },
                    { id: '2', dist: '土城', name: '李阿姨', items: { sku_big: 2 } }, // 假設土城有兩單，共4瓶
                    { id: '3', dist: '土城', name: '張老闆', items: { sku_big: 2 } },
                    { id: '4', dist: '木柵', name: '陳公館', items: { sku_big: 4 } },
                    { id: '5', dist: '士林', name: '林小姐', items: { sku_big: 2 } },
                    { id: '6', dist: '蘆洲', name: '早餐店', items: { sku_big: 3 } }, // 系統目前是3
                    { id: '7', dist: '圓山', name: '遊客A', items: { sku_big: 2 } }  // 系統目前是2
                ];

                activeDates.value = [{
                    key: today,
                    label: '今日配送',
                    orders: mockOrders.map(o => ({...o, distMismatch: false, isDone: false}))
                }];
            };

            // --- 核心邏輯：文字解析與比對 ---
            const parseAndCompare = () => {
                const text = reconciler.value.text;
                if (!text) { reconciler.value.diffs = []; return; }

                // 1. 解析輸入文字 (Regex: 中文 + 數字)
                // 支援格式: "樹林1 土城4" 或 "樹林 1\n土城 4"
                const regex = /([\u4e00-\u9fa5]+)\s*(\d+)/g;
                let match;
                const inputMap = {};
                
                while ((match = regex.exec(text)) !== null) {
                    const dist = match[1];
                    const qty = parseInt(match[2]);
                    inputMap[dist] = (inputMap[dist] || 0) + qty;
                }

                // 2. 統計系統當前(今日)數量
                const sysMap = {};
                const todayOrders = activeDates.value[0]?.orders || [];
                
                todayOrders.forEach(o => {
                    // 這裡簡化計算，假設每單都是計算總瓶數 (或可依據需求改成特定SKU)
                    let total = 0;
                    Object.values(o.items).forEach(q => total += q);
                    sysMap[o.dist] = (sysMap[o.dist] || 0) + total;
                });

                // 3. 產生比對表 (合併所有出現過的區域)
                const allDistricts = new Set([...Object.keys(inputMap), ...Object.keys(sysMap)]);
                const results = [];

                allDistricts.forEach(dist => {
                    const inputQty = inputMap[dist] || 0;
                    const sysQty = sysMap[dist] || 0;
                    const diff = inputQty - sysQty;
                    
                    // 只顯示有輸入的，或系統有但輸入漏掉的(可選)
                    // 這裡策略：只要該區域被提及或存在，就顯示
                    results.push({
                        district: dist,
                        inputQty,
                        sysQty,
                        diff // >0: 系統少(需補), <0: 系統多(需刪), 0: 吻合
                    });
                });

                // 排序：有問題的排前面
                results.sort((a, b) => {
                    const aProblem = a.diff !== 0 ? 1 : 0;
                    const bProblem = b.diff !== 0 ? 1 : 0;
                    return bProblem - aProblem;
                });

                reconciler.value.diffs = results;
            };

            // --- 視覺輔助 ---
            const getStatusColor = (diff) => {
                if (diff === 0) return 'text-emerald-400';
                if (diff > 0) return 'text-yellow-400'; // 輸入比系統多 -> 系統漏單
                return 'text-red-400'; // 輸入比系統少 -> 系統多單 (需刪)
            };

            const getStatusIcon = (diff) => {
                if (diff === 0) return 'fas fa-check-circle';
                if (diff > 0) return 'fas fa-plus-circle';
                return 'fas fa-minus-circle';
            };

            const getStatusText = (diff) => {
                if (diff === 0) return '吻合';
                if (diff > 0) return `少 ${Math.abs(diff)}`; // 系統少了
                return `多 ${Math.abs(diff)}`; // 系統多了
            };

            const hasErrors = computed(() => reconciler.value.diffs.some(d => d.diff !== 0));
            const errorCount = computed(() => reconciler.value.diffs.filter(d => d.diff !== 0).length);

            // 標記功能：將有問題的區域在看板上亮起
            const highlightErrors = () => {
                const problemDistricts = reconciler.value.diffs
                    .filter(d => d.diff !== 0)
                    .map(d => d.district);
                
                if (activeDates.value[0]) {
                    activeDates.value[0].orders.forEach(o => {
                        o.distMismatch = problemDistricts.includes(o.dist);
                    });
                }
                reconciler.value.open = false; // 關閉視窗，讓使用者去操作卡片
            };

            // 今日統計
            const currentDayStats = computed(() => {
                let b = 0, w = 0;
                (activeDates.value[0]?.orders || []).forEach(o => {
                    Object.entries(o.items).forEach(([k, q]) => {
                        b += q;
                        w += q * (PRODUCT_CONFIG[k]?.weight || 0);
                    });
                });
                return { bottles: b, weight: w };
            });

            // Helpers
            const getProductColor = (sku) => PRODUCT_CONFIG[sku]?.color;
            const getProductName = (sku) => PRODUCT_CONFIG[sku]?.name;

            onMounted(() => initData());

            return {
                activeDates, reconciler, currentDayStats, hasErrors, errorCount,
                parseAndCompare, getStatusColor, getStatusIcon, getStatusText, highlightErrors,
                getProductColor, getProductName
            };
        }
    }).mount('#app');
</script>
</body>
</html>
